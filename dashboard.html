<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Territory Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981',
                        secondary: '#3B82F6',
                        dark: { 950: '#050507', 900: '#0a0a0f', 800: '#12121a', 700: '#1a1a24' },
                        accent: '#F59E0B',
                        danger: '#EF4444'
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Mappls Map SDK -->
    <script src="https://apis.mappls.com/advancedmaps/api/798fea4714e50cccb239aaf472ee4fde/map_sdk?layer=vector&v=3.0&callback=initMap1"></script>
    <style id="mappls-style"></style>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; background: #050507; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #12121a; }
        ::-webkit-scrollbar-thumb { background: #10B981; border-radius: 3px; }

        .sidebar {
            width: 320px;
            height: 100vh;
            background: linear-gradient(180deg, #0a0a0f 0%, #12121a 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 50;
        }

        .glass-card {
            background: rgba(18, 18, 26, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #050507;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 1.5s ease-out infinite;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-idle { background: rgba(107, 114, 128, 0.2); color: #9CA3AF; }
        .status-running { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .status-closable { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }

        .leaderboard-entry {
            transition: all 0.3s ease;
        }
        .leaderboard-entry:hover {
            background: rgba(16, 185, 129, 0.1);
            transform: translateX(4px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
            animation: glow-pulse 1s infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
            50% { box-shadow: 0 4px 30px rgba(34, 197, 94, 0.6); }
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .control-panel {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .run-stats-overlay {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 100;
            min-width: 240px;
        }

        .safety-warning {
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #FCD34D;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 90%;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: #050507;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10B981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -320px;
                transition: left 0.3s ease;
                z-index: 200;
            }
            .sidebar.open { left: 0; }
            .mobile-menu-btn { display: flex !important; }
            .sidebar-overlay {
                display: block;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 150;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 500;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.success { border-color: rgba(16, 185, 129, 0.5); }
        .toast.error { border-color: rgba(239, 68, 68, 0.5); }
        .toast.warning { border-color: rgba(245, 158, 11, 0.5); }

        .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }

        .avatar-ring {
            padding: 3px;
            background: linear-gradient(135deg, #10B981 0%, #059669 50%, #10B981 100%);
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .control-panel {
                bottom: 100px;
                padding: 12px 16px;
                gap: 12px;
                max-width: 95%;
                flex-wrap: wrap;
                justify-content: center;
            }
            .control-panel button {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* Live Stats Panel - ALWAYS VISIBLE */
        .live-stats-panel {
            position: absolute;
            top: 80px;
            left: 24px;
            z-index: 100;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px;
            padding: 16px;
            min-width: 200px;
        }

        .live-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .live-stat:last-child { border-bottom: none; }
        .live-stat-label { font-size: 12px; color: #9CA3AF; text-transform: uppercase; }
        .live-stat-value { font-size: 18px; font-weight: 700; color: #10B981; }
        .live-stat-value.large { font-size: 24px; }

        /* Follow mode indicator */
        .follow-indicator {
            position: absolute;
            top: 24px;
            left: 24px;
            z-index: 100;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.5);
            color: #10B981;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .follow-indicator.hidden { display: none; }
    </style>
</head>
<body class="bg-dark-950 text-white antialiased">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-gray-400">Loading Territory Run...</p>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay hidden lg:hidden" onclick="toggleSidebar()"></div>

    <!-- Main Container -->
    <div class="flex h-screen w-screen overflow-hidden">

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <!-- Logo -->
            <div class="p-6 border-b border-white/5">
                <a href="index.html" class="flex items-center space-x-3 group">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-emerald-600 rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                        <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/>
                            <line x1="9" y1="3" x2="9" y2="18"/>
                            <line x1="15" y1="6" x2="15" y2="21"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold tracking-tight">
                        Territory<span class="text-primary">Run</span>
                    </span>
                </a>
            </div>

            <!-- Profile Section -->
            <div class="p-6 border-b border-white/5">
                <div class="flex items-center space-x-4">
                    <div class="avatar-ring">
                        <img id="userAvatar" src="" alt="Avatar" class="w-14 h-14 rounded-full object-cover bg-dark-700">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 id="userGamertag" class="font-bold text-lg truncate">Loading...</h3>
                        <p id="userEmail" class="text-sm text-gray-400 truncate">loading@email.com</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-5">
                    <div class="stat-card">
                        <div class="flex items-center space-x-2 mb-1">
                            <svg class="w-4 h-4 text-yellow-500" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                            <span class="text-xs text-gray-400 uppercase tracking-wider">Coins</span>
                        </div>
                        <p id="userCoins" class="text-2xl font-bold text-white">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center space-x-2 mb-1">
                            <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/>
                            </svg>
                            <span class="text-xs text-gray-400 uppercase tracking-wider">Area</span>
                        </div>
                        <p id="userArea" class="text-2xl font-bold text-white">0<span class="text-sm font-normal text-gray-400"> mÂ²</span></p>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="flex-1 overflow-hidden flex flex-col p-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold text-sm uppercase tracking-wider text-gray-400">Leaderboard</h4>
                    <span class="text-xs text-primary">Top 10</span>
                </div>
                <div id="leaderboard" class="flex-1 overflow-y-auto space-y-2 pr-2">
                    <div class="text-center py-8 text-gray-500">
                        <div class="spinner mx-auto mb-3" style="width: 24px; height: 24px; border-width: 2px;"></div>
                        <p class="text-sm">Loading leaderboard...</p>
                    </div>
                </div>
            </div>

            <!-- Logout Button -->
            <div class="p-6 border-t border-white/5">
                <button onclick="logout()" class="w-full flex items-center justify-center space-x-2 py-3 px-4 rounded-xl bg-dark-800 hover:bg-dark-700 border border-white/5 hover:border-white/10 transition-all text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 relative overflow-hidden">
            
            <!-- Mobile Menu Button -->
            <button id="mobileMenuBtn" onclick="toggleSidebar()" class="mobile-menu-btn hidden fixed top-4 left-4 z-[201] p-3 bg-dark-900/90 backdrop-blur-lg rounded-xl border border-white/10 lg:hidden">
                <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>

            <!-- Follow Mode Indicator -->
            <div id="followIndicator" class="follow-indicator hidden">
                <span class="w-2 h-2 bg-primary rounded-full animate-pulse"></span>
                <span>Following You</span>
            </div>

            <!-- Safety Warning -->
            <div id="safetyWarning" class="safety-warning">
                <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <span>Stay safe! Avoid traffic and restricted areas.</span>
                <button onclick="dismissWarning()" class="ml-2 hover:text-white transition-colors">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- LIVE STATS PANEL - Shows during run -->
            <div id="liveStatsPanel" class="live-stats-panel hidden">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-400 uppercase tracking-wider">Live Run</span>
                    <span id="runStatusBadge" class="status-badge status-running">
                        <span class="w-2 h-2 bg-primary rounded-full animate-pulse"></span>
                        Running
                    </span>
                </div>
                
                <div class="live-stat">
                    <span class="live-stat-label">Distance</span>
                    <span id="liveDistance" class="live-stat-value large">0 m</span>
                </div>
                
                <div class="live-stat">
                    <span class="live-stat-label">Duration</span>
                    <span id="liveDuration" class="live-stat-value">00:00</span>
                </div>
                
                <div class="live-stat">
                    <span class="live-stat-label">Points</span>
                    <span id="livePoints" class="live-stat-value">0</span>
                </div>
                
                <div class="live-stat">
                    <span class="live-stat-label">Area</span>
                    <span id="liveArea" class="live-stat-value">0 mÂ²</span>
                </div>
                
                <div class="live-stat">
                    <span class="live-stat-label">To Start</span>
                    <span id="liveToStart" class="live-stat-value">-- m</span>
                </div>

                <div class="live-stat">
                    <span class="live-stat-label">Speed</span>
                    <span id="liveSpeed" class="live-stat-value">0 km/h</span>
                </div>
                
                <!-- Loop Progress -->
                <div id="loopProgressContainer" class="mt-3 hidden">
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-400">Loop Progress</span>
                        <span id="loopProgressText" class="text-primary">0%</span>
                    </div>
                    <div class="h-2 bg-dark-700 rounded-full overflow-hidden">
                        <div id="loopProgressBar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div id="map"></div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div id="locationStatus" class="flex items-center space-x-2">
                    <div class="relative">
                        <div class="w-3 h-3 bg-gray-500 rounded-full" id="gpsIndicator"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-primary rounded-full pulse-ring hidden" id="gpsPulse"></div>
                    </div>
                    <span id="gpsStatusText" class="text-sm text-gray-400">Acquiring GPS...</span>
                </div>

                <div class="w-px h-8 bg-white/10"></div>

                <button id="startRunBtn" onclick="startRun()" class="btn-primary flex items-center space-x-2" disabled>
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    <span>Start Run</span>
                </button>

                <button id="stopRunBtn" onclick="stopRun()" class="btn-danger hidden items-center space-x-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                    <span>Cancel</span>
                </button>

                <button id="closeLoopBtn" onclick="closeLoop()" class="btn-success hidden items-center space-x-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <span>Capture!</span>
                </button>

                <button onclick="centerOnUser()" class="p-3 bg-dark-800 hover:bg-dark-700 rounded-xl border border-white/10 transition-all" title="Center on me">
                    <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                    </svg>
                </button>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <svg id="toastIcon" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
        <span id="toastMessage">Notification</span>
    </div>

    <script>
    window.initMap1 = function() {
        console.log('Mappls SDK ready');
        window.mapplsSDKReady = true;
    };
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, onSnapshot, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAqIobLBC_cfW_hfw5P073Go_dW7MbLR6s",
            authDomain: "territory-run-e7df3.firebaseapp.com",
            projectId: "territory-run-e7df3",
            storageBucket: "territory-run-e7df3.firebasestorage.app",
            messagingSenderId: "733520135692",
            appId: "1:733520135692:web:74923175464454eb7cd029"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseIncrement = increment;

        // ================================
        // GLOBAL STATE
        // ================================
        window.currentUser = null;
        window.userData = null;
        window.mapInstance = null;
        window.userMarker = null;
        window.safeZoneCircle = null;
        window.trailPath = []; // Array of LatLng for polyline
        window.trailPolyline = null;
        window.startMarker = null;
        window.capturedPolygons = [];

        // Run State
        window.isRunning = false;
        window.runPath = []; // Array of {lat, lng, timestamp}
        window.runStartTime = null;
        window.runTimer = null;
        window.gpsWatchId = null;
        window.currentPosition = null;
        window.canCloseLoop = false;
        window.followMode = true; // Auto-center on user

        // Speed tracking
        window.lastPositionTime = null;
        window.lastPosition = null;
        window.currentSpeed = 0;

        // Game Constants
        window.SAFE_ZONE_RADIUS = 20;
        window.LOOP_CLOSURE_THRESHOLD = 25;
        window.MIN_CAPTURE_AREA = 50;
        window.COINS_PER_100_SQM = 1;
        window.BONUS_COINS_PER_RUN = 10;
        window.MIN_PATH_POINTS = 5;
        window.MIN_POINT_DISTANCE = 3; // Minimum meters between recorded points

        // ================================
        // AUTHENTICATION
        // ================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('User authenticated:', user.uid);
                window.currentUser = user;
                await loadUserData(user);
                initializeMap();
                setupLeaderboardListener();
                startGPSTracking();
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 500);
            } else {
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.querySelector('p').textContent = 'Redirecting to login...';
                setTimeout(() => { window.location.href = 'login.html'; }, 1000);
            }
        });

        async function loadUserData(user) {
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    window.userData = userDocSnap.data();
                    if (window.userData.totalArea === undefined) {
                        await updateDoc(userDocRef, { totalArea: 0, coins: 0 });
                        window.userData.totalArea = 0;
                        window.userData.coins = 0;
                    }
                } else {
                    const defaultData = {
                        gamertag: user.displayName || 'Runner' + user.uid.substring(0, 6),
                        email: user.email || user.phoneNumber || 'Unknown',
                        avatarUrl: user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${user.uid}`,
                        coins: 0,
                        totalArea: 0,
                        territoriesCaptured: 0,
                        createdAt: new Date().toISOString(),
                        lastActive: new Date().toISOString()
                    };
                    await setDoc(userDocRef, defaultData);
                    window.userData = defaultData;
                }
                updateUserUI();
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Failed to load user data', 'error');
            }
        }

        window.updateUserUI = function() {
            if (!window.userData) return;
            document.getElementById('userAvatar').src = window.userData.avatarUrl || 
                `https://api.dicebear.com/9.x/avataaars/svg?seed=${window.currentUser.uid}`;
            document.getElementById('userGamertag').textContent = window.userData.gamertag || 'Runner';
            document.getElementById('userEmail').textContent = window.userData.email || '';
            document.getElementById('userCoins').textContent = formatNumber(window.userData.coins || 0);
            document.getElementById('userArea').innerHTML = `${formatNumber(Math.round(window.userData.totalArea || 0))}<span class="text-sm font-normal text-gray-400"> mÂ²</span>`;
        };

        function setupLeaderboardListener() {
            const usersRef = collection(db, 'users');
            const leaderboardQuery = query(usersRef, orderBy('createdAt', 'desc'));

            onSnapshot(leaderboardQuery, (snapshot) => {
                const container = document.getElementById('leaderboard');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = `<div class="text-center py-8 text-gray-500"><p class="text-sm">No players yet!</p></div>`;
                    return;
                }

                const users = [];
                snapshot.forEach((doc) => {
                    users.push({ id: doc.id, ...doc.data(), totalArea: doc.data().totalArea || 0 });
                });

                users.sort((a, b) => b.totalArea - a.totalArea);
                users.slice(0, 10).forEach((data, index) => {
                    container.innerHTML += createLeaderboardEntry(index + 1, data, data.id === window.currentUser?.uid);
                });
            });
        }

        function createLeaderboardEntry(rank, data, isCurrentUser) {
            let rankClass = 'bg-dark-700 text-gray-400';
            if (rank === 1) rankClass = 'rank-1 text-dark-950';
            else if (rank === 2) rankClass = 'rank-2 text-dark-950';
            else if (rank === 3) rankClass = 'rank-3 text-white';

            return `
                <div class="leaderboard-entry flex items-center space-x-3 p-3 rounded-xl ${isCurrentUser ? 'bg-primary/10 border border-primary/20' : 'hover:bg-white/5'}">
                    <div class="w-7 h-7 rounded-full ${rankClass} flex items-center justify-center text-xs font-bold">${rank}</div>
                    <img src="${data.avatarUrl || `https://api.dicebear.com/9.x/avataaars/svg?seed=${data.gamertag}`}" class="w-9 h-9 rounded-full bg-dark-700">
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-sm truncate ${isCurrentUser ? 'text-primary' : 'text-white'}">${data.gamertag || 'Unknown'}</p>
                        <p class="text-xs text-gray-500">${formatNumber(Math.round(data.totalArea))} mÂ²</p>
                    </div>
                    ${isCurrentUser ? '<span class="text-xs text-primary font-medium">YOU</span>' : ''}
                </div>
            `;
        }

        window.logout = async function() {
            if (window.isRunning) stopRun(true);
            if (window.gpsWatchId) navigator.geolocation.clearWatch(window.gpsWatchId);
            await signOut(auth);
            window.location.href = 'login.html';
        };

        window.updateUserStats = async function(areaGained, coinsGained) {
            if (!window.currentUser) return;
            try {
                const userDocRef = doc(db, 'users', window.currentUser.uid);
                await updateDoc(userDocRef, {
                    totalArea: increment(areaGained),
                    coins: increment(coinsGained),
                    territoriesCaptured: increment(1),
                    lastActive: new Date().toISOString()
                });
                window.userData.totalArea = (window.userData.totalArea || 0) + areaGained;
                window.userData.coins = (window.userData.coins || 0) + coinsGained;
                updateUserUI();
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        };
    </script>

    <!-- HELPER FUNCTIONS -->
    <script>
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.classList.remove('success', 'error', 'warning');
            let iconPath = '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>';
            
            if (type === 'success') {
                toast.classList.add('success');
                iconPath = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>';
                toastIcon.style.color = '#10B981';
            } else if (type === 'error') {
                toast.classList.add('error');
                iconPath = '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>';
                toastIcon.style.color = '#EF4444';
            } else if (type === 'warning') {
                toast.classList.add('warning');
                iconPath = '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>';
                toastIcon.style.color = '#F59E0B';
            }

            toastIcon.innerHTML = iconPath;
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 4000);
        }
        window.showToast = showToast;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('hidden');
        }
        window.toggleSidebar = toggleSidebar;

        function dismissWarning() {
            const warning = document.getElementById('safetyWarning');
            warning.style.display = 'none';
            localStorage.setItem('safetyWarningDismissed', 'true');
        }
        window.dismissWarning = dismissWarning;

        if (localStorage.getItem('safetyWarningDismissed') === 'true') {
            document.getElementById('safetyWarning').style.display = 'none';
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        window.formatNumber = formatNumber;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        window.formatTime = formatTime;

        function toRad(deg) { return deg * (Math.PI / 180); }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        window.calculateDistance = calculateDistance;

        function calculatePolygonArea(coords) {
            if (coords.length < 3) return 0;
            let area = 0;
            for (let i = 0; i < coords.length; i++) {
                const j = (i + 1) % coords.length;
                const xi = coords[i].lng * 111320 * Math.cos(toRad(coords[i].lat));
                const yi = coords[i].lat * 110540;
                const xj = coords[j].lng * 111320 * Math.cos(toRad(coords[j].lat));
                const yj = coords[j].lat * 110540;
                area += xi * yj - xj * yi;
            }
            return Math.abs(area / 2);
        }
        window.calculatePolygonArea = calculatePolygonArea;

        function calculatePathDistance(path) {
            if (path.length < 2) return 0;
            let total = 0;
            for (let i = 1; i < path.length; i++) {
                total += calculateDistance(path[i-1].lat, path[i-1].lng, path[i].lat, path[i].lng);
            }
            return total;
        }
        window.calculatePathDistance = calculatePathDistance;

        function updateGPSStatus(status, message) {
            const indicator = document.getElementById('gpsIndicator');
            const pulse = document.getElementById('gpsPulse');
            const text = document.getElementById('gpsStatusText');
            
            indicator.classList.remove('bg-gray-500', 'bg-primary', 'bg-red-500', 'bg-yellow-500');
            
            if (status === 'active') {
                indicator.classList.add('bg-primary');
                pulse.classList.remove('hidden');
            } else if (status === 'error') {
                indicator.classList.add('bg-red-500');
                pulse.classList.add('hidden');
            } else {
                indicator.classList.add('bg-gray-500');
                pulse.classList.add('hidden');
            }
            text.textContent = message;
        }
        window.updateGPSStatus = updateGPSStatus;
    </script>

    <!-- MAIN MAP & GAME LOGIC -->
    <script>
        // ================================
        // MAP INITIALIZATION
        // ================================
        function initializeMap() {
            if (typeof mappls === 'undefined' || !window.mapplsSDKReady) {
                console.log('Waiting for Mappls SDK...');
                setTimeout(initializeMap, 300);
                return;
            }

            try {
                window.mapInstance = new mappls.Map('map', {
                    center: [28.6139, 77.2090],
                    zoom: 18,
                    zoomControl: true,
                    location: true
                });

                window.mapInstance.on('load', () => {
                    console.log('âœ… Map loaded');
                    if (window.currentPosition) {
                        centerOnUser();
                        showSafeZone(window.currentPosition.lat, window.currentPosition.lng);
                    }
                });
            } catch (error) {
                console.error('Map init error:', error);
            }
        }
        window.initializeMap = initializeMap;

        // ================================
        // GPS TRACKING - THE CORE
        // ================================
        function startGPSTracking() {
            if (!navigator.geolocation) {
                updateGPSStatus('error', 'GPS not supported');
                showToast('GPS not supported on this device', 'error');
                return;
            }

            updateGPSStatus('warning', 'Acquiring GPS...');

            const gpsOptions = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            // Initial position
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    onGPSUpdate(pos);
                    document.getElementById('startRunBtn').disabled = false;
                },
                (err) => {
                    console.error('Initial GPS error:', err);
                    updateGPSStatus('error', 'GPS failed');
                },
                gpsOptions
            );

            // Continuous tracking
            window.gpsWatchId = navigator.geolocation.watchPosition(
                onGPSUpdate,
                (err) => {
                    console.error('GPS watch error:', err);
                    updateGPSStatus('error', 'GPS signal lost');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );

            console.log('ðŸ›°ï¸ GPS tracking started');
        }
        window.startGPSTracking = startGPSTracking;

        // ================================
        // GPS UPDATE HANDLER - CALLED EVERY GPS TICK
        // ================================
        function onGPSUpdate(position) {
            const { latitude: lat, longitude: lng, accuracy, speed } = position.coords;
            const now = Date.now();

            // Calculate speed if GPS doesn't provide it
            if (window.lastPosition && window.lastPositionTime) {
                const dist = calculateDistance(window.lastPosition.lat, window.lastPosition.lng, lat, lng);
                const timeDiff = (now - window.lastPositionTime) / 1000;
                if (timeDiff > 0) {
                    window.currentSpeed = (dist / timeDiff) * 3.6; // km/h
                }
            }

            // Store previous for speed calc
            window.lastPosition = { lat, lng };
            window.lastPositionTime = now;

            // Update current position
            window.currentPosition = { lat, lng, accuracy, timestamp: now };

            // Update GPS status
            updateGPSStatus('active', `GPS Â±${Math.round(accuracy)}m`);
            document.getElementById('startRunBtn').disabled = false;

            // === ALWAYS UPDATE USER MARKER (LIVE TRACKING) ===
            updateUserMarker(lat, lng);

            // === IF RUNNING, RECORD THE PATH ===
            if (window.isRunning) {
                recordPathPoint(lat, lng);
                updateLiveStats();
            } else {
                // Update safe zone when idle
                showSafeZone(lat, lng);
            }

            // Auto-follow if enabled
            if (window.followMode && window.mapInstance) {
                window.mapInstance.panTo([lng, lat]);
            }
        }

        // ================================
        // UPDATE USER MARKER ON MAP
        // ================================
        function updateUserMarker(lat, lng) {
            if (!window.mapInstance) return;

            if (window.userMarker) {
                window.userMarker.setPosition(new mappls.LatLng(lat, lng));
            } else {
                // Create marker with pulsing effect
                const el = document.createElement('div');
                el.innerHTML = `
                    <div style="position:relative; width:24px; height:24px;">
                        <div style="position:absolute; top:4px; left:4px; width:16px; height:16px; background:#10B981; border:3px solid white; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>
                        <div style="position:absolute; inset:0; border:2px solid rgba(16,185,129,0.5); border-radius:50%; animation:pulse-ring 1.5s ease-out infinite;"></div>
                    </div>
                `;
                window.userMarker = new mappls.Marker({
                    map: window.mapInstance,
                    position: new mappls.LatLng(lat, lng),
                    element: el,
                    fitbounds: false
                });
            }
        }

        // ================================
        // SHOW/HIDE SAFE ZONE
        // ================================
        function showSafeZone(lat, lng) {
            if (!window.mapInstance || window.isRunning) return;

            if (window.safeZoneCircle) {
                try { window.safeZoneCircle.remove(); } catch(e) {}
            }

            window.safeZoneCircle = new mappls.Circle({
                map: window.mapInstance,
                center: new mappls.LatLng(lat, lng),
                radius: window.SAFE_ZONE_RADIUS,
                strokeColor: '#10B981',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#10B981',
                fillOpacity: 0.15
            });
        }

        function hideSafeZone() {
            if (window.safeZoneCircle) {
                try { window.safeZoneCircle.remove(); } catch(e) {}
                window.safeZoneCircle = null;
            }
        }

        // ================================
        // RECORD PATH POINT DURING RUN
        // ================================
        function recordPathPoint(lat, lng) {
            if (!window.isRunning) return;

            // Check minimum distance from last point
            if (window.runPath.length > 0) {
                const last = window.runPath[window.runPath.length - 1];
                const dist = calculateDistance(last.lat, last.lng, lat, lng);
                if (dist < window.MIN_POINT_DISTANCE) {
                    return; // Too close, skip
                }
            }

            // Add new point
            window.runPath.push({ lat, lng, timestamp: Date.now() });
            console.log(`ðŸ“ Point ${window.runPath.length}: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);

            // Update trail on map
            updateTrailOnMap();

            // Check if loop can be closed
            checkLoopStatus();
        }

        // ================================
        // UPDATE TRAIL POLYLINE ON MAP
        // ================================
        function updateTrailOnMap() {
            if (!window.mapInstance || window.runPath.length < 1) return;

            const pathCoords = window.runPath.map(p => [p.lng, p.lat]);

            if (window.trailPolyline) {
                try {
                    window.trailPolyline.remove();
                } catch(e) {}
            }

            // Create new polyline with updated path
            window.trailPolyline = new mappls.Polyline({
                map: window.mapInstance,
                paths: pathCoords,
                strokeColor: '#10B981',
                strokeOpacity: 1,
                strokeWeight: 5
            });
        }

        // ================================
        // UPDATE LIVE STATS DURING RUN
        // ================================
        function updateLiveStats() {
            if (!window.isRunning) return;

            const distance = calculatePathDistance(window.runPath);
            const area = calculatePolygonArea(window.runPath);
            const elapsed = (Date.now() - window.runStartTime) / 1000;

            document.getElementById('liveDistance').textContent = `${Math.round(distance)} m`;
            document.getElementById('liveDuration').textContent = formatTime(elapsed);
            document.getElementById('livePoints').textContent = window.runPath.length;
            document.getElementById('liveArea').textContent = `${Math.round(area)} mÂ²`;
            document.getElementById('liveSpeed').textContent = `${Math.round(window.currentSpeed)} km/h`;

            // Distance to start
            if (window.runPath.length > 0 && window.currentPosition) {
                const start = window.runPath[0];
                const distToStart = calculateDistance(start.lat, start.lng, 
                    window.currentPosition.lat, window.currentPosition.lng);
                document.getElementById('liveToStart').textContent = `${Math.round(distToStart)} m`;
            }
        }

        // ================================
        // CHECK IF LOOP CAN BE CLOSED
        // ================================
        function checkLoopStatus() {
            if (!window.isRunning || window.runPath.length < window.MIN_PATH_POINTS) return;

            const start = window.runPath[0];
            const current = window.runPath[window.runPath.length - 1];
            const distToStart = calculateDistance(start.lat, start.lng, current.lat, current.lng);

            const progressContainer = document.getElementById('loopProgressContainer');
            const progressBar = document.getElementById('loopProgressBar');
            const progressText = document.getElementById('loopProgressText');

            if (distToStart < 100) {
                progressContainer.classList.remove('hidden');
                const progress = Math.max(0, Math.min(100, (1 - distToStart / 100) * 100));
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}%`;

                if (distToStart <= window.LOOP_CLOSURE_THRESHOLD) {
                    if (!window.canCloseLoop) {
                        window.canCloseLoop = true;
                        progressBar.classList.remove('bg-primary');
                        progressBar.classList.add('bg-green-400');
                        
                        document.getElementById('closeLoopBtn').classList.remove('hidden');
                        document.getElementById('closeLoopBtn').classList.add('flex');
                        document.getElementById('stopRunBtn').classList.add('hidden');
                        
                        document.getElementById('runStatusBadge').innerHTML = '<span class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>Close Now!';
                        document.getElementById('runStatusBadge').classList.remove('status-running');
                        document.getElementById('runStatusBadge').classList.add('status-closable');

                        showToast('ðŸŽ¯ Loop ready! Tap CAPTURE to claim territory!', 'success');
                    }
                } else {
                    window.canCloseLoop = false;
                    progressBar.classList.add('bg-primary');
                    progressBar.classList.remove('bg-green-400');
                    
                    document.getElementById('closeLoopBtn').classList.add('hidden');
                    document.getElementById('stopRunBtn').classList.remove('hidden');
                    document.getElementById('stopRunBtn').classList.add('flex');
                    
                    document.getElementById('runStatusBadge').innerHTML = '<span class="w-2 h-2 bg-primary rounded-full animate-pulse"></span>Running';
                    document.getElementById('runStatusBadge').classList.add('status-running');
                    document.getElementById('runStatusBadge').classList.remove('status-closable');
                }
            } else {
                progressContainer.classList.add('hidden');
                window.canCloseLoop = false;
            }
        }

        // ================================
        // CENTER ON USER
        // ================================
        function centerOnUser() {
            if (!window.currentPosition || !window.mapInstance) {
                showToast('Waiting for GPS...', 'warning');
                return;
            }
            window.mapInstance.flyTo({
                center: [window.currentPosition.lng, window.currentPosition.lat],
                zoom: 18
            });
            window.followMode = true;
            document.getElementById('followIndicator').classList.remove('hidden');
        }
        window.centerOnUser = centerOnUser;

        // ================================
        // START RUN
        // ================================
        function startRun() {
            if (!window.currentPosition) {
                showToast('Waiting for GPS signal...', 'warning');
                return;
            }

            console.log('ðŸƒ === STARTING RUN ===');

            window.isRunning = true;
            window.runPath = [];
            window.runStartTime = Date.now();
            window.canCloseLoop = false;
            window.followMode = true;

            // Add starting point
            window.runPath.push({
                lat: window.currentPosition.lat,
                lng: window.currentPosition.lng,
                timestamp: Date.now()
            });

            // UI Updates
            document.getElementById('startRunBtn').classList.add('hidden');
            document.getElementById('stopRunBtn').classList.remove('hidden');
            document.getElementById('stopRunBtn').classList.add('flex');
            document.getElementById('liveStatsPanel').classList.remove('hidden');
            document.getElementById('followIndicator').classList.remove('hidden');

            // Hide safe zone
            hideSafeZone();

            // Create start marker
            createStartMarker(window.currentPosition.lat, window.currentPosition.lng);

            // Initialize trail
            updateTrailOnMap();

            // Start timer
            window.runTimer = setInterval(() => {
                const elapsed = (Date.now() - window.runStartTime) / 1000;
                document.getElementById('liveDuration').textContent = formatTime(elapsed);
            }, 1000);

            // Center map
            centerOnUser();

            showToast('ðŸƒ Run started! Create a loop to capture territory!', 'success');
        }
        window.startRun = startRun;

        // ================================
        // CREATE START MARKER
        // ================================
        function createStartMarker(lat, lng) {
            if (!window.mapInstance) return;

            if (window.startMarker) {
                try { window.startMarker.remove(); } catch(e) {}
            }

            const el = document.createElement('div');
            el.innerHTML = `
                <div style="width:24px; height:24px; background:#F59E0B; border:3px solid white; border-radius:50%; box-shadow:0 2px 10px rgba(0,0,0,0.4);"></div>
            `;
            el.title = 'Start Point - Return here!';

            window.startMarker = new mappls.Marker({
                map: window.mapInstance,
                position: new mappls.LatLng(lat, lng),
                element: el,
                fitbounds: false
            });
        }

        // ================================
        // STOP RUN (CANCEL)
        // ================================
        function stopRun(silent = false) {
            if (!window.isRunning) return;

            console.log('âŒ === STOPPING RUN ===');

            if (!silent) {
                showToast('Run cancelled. No territory captured.', 'warning');
            }

            endRun();
        }
        window.stopRun = stopRun;

        // ================================
        // CLOSE LOOP (CAPTURE TERRITORY)
        // ================================
        function closeLoop() {
            if (!window.isRunning || !window.canCloseLoop) {
                showToast('Get closer to start point!', 'warning');
                return;
            }

            console.log('âœ… === CLOSING LOOP ===');

            // Close the polygon
            const start = window.runPath[0];
            window.runPath.push({ lat: start.lat, lng: start.lng, timestamp: Date.now() });

            // Calculate area
            const capturedArea = calculatePolygonArea(window.runPath);
            console.log('Captured area:', capturedArea);

            if (capturedArea >= window.MIN_CAPTURE_AREA) {
                const coins = Math.floor(capturedArea / 100) * window.COINS_PER_100_SQM + window.BONUS_COINS_PER_RUN;

                // Draw green filled polygon
                drawCapturedPolygon(window.runPath);

                // Save to Firebase
                window.updateUserStats(capturedArea, coins);

                showToast(`ðŸŽ‰ Captured ${Math.round(capturedArea)} mÂ²! +${coins} coins!`, 'success');
            } else {
                showToast(`Area too small (${Math.round(capturedArea)} mÂ²). Need ${window.MIN_CAPTURE_AREA}+ mÂ²`, 'warning');
            }

            endRun();
        }
        window.closeLoop = closeLoop;

        // ================================
        // END RUN (CLEANUP)
        // ================================
        function endRun() {
            window.isRunning = false;
            window.runStartTime = null;
            window.canCloseLoop = false;

            if (window.runTimer) {
                clearInterval(window.runTimer);
                window.runTimer = null;
            }

            // UI Reset
            document.getElementById('startRunBtn').classList.remove('hidden');
            document.getElementById('stopRunBtn').classList.add('hidden');
            document.getElementById('closeLoopBtn').classList.add('hidden');
            document.getElementById('liveStatsPanel').classList.add('hidden');
            document.getElementById('loopProgressContainer').classList.add('hidden');
            document.getElementById('followIndicator').classList.add('hidden');

            // Remove start marker
            if (window.startMarker) {
                try { window.startMarker.remove(); } catch(e) {}
                window.startMarker = null;
            }

            // Remove trail
            if (window.trailPolyline) {
                try { window.trailPolyline.remove(); } catch(e) {}
                window.trailPolyline = null;
            }

            // Clear path
            window.runPath = [];

            // Show safe zone again
            if (window.currentPosition) {
                showSafeZone(window.currentPosition.lat, window.currentPosition.lng);
            }
        }

        // ================================
        // DRAW CAPTURED POLYGON (GREEN FILL)
        // ================================
        function drawCapturedPolygon(path) {
            if (!window.mapInstance) return;

            const coords = path.map(p => [p.lng, p.lat]);

            const polygon = new mappls.Polygon({
                map: window.mapInstance,
                paths: coords,
                fillColor: '#10B981',
                fillOpacity: 0.4,
                strokeColor: '#059669',
                strokeOpacity: 1,
                strokeWeight: 3
            });

            window.capturedPolygons.push(polygon);
            console.log('âœ… Captured polygon drawn');
        }

        // ================================
        // KEYBOARD SHORTCUTS
        // ================================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            if (e.code === 'Space') {
                e.preventDefault();
                if (window.canCloseLoop) closeLoop();
                else if (window.isRunning) stopRun();
                else if (window.currentPosition) startRun();
            }

            if (e.code === 'KeyC') {
                centerOnUser();
            }
        });

        // Prevent accidental page close during run
        window.addEventListener('beforeunload', (e) => {
            if (window.isRunning) {
                e.preventDefault();
                e.returnValue = 'You have an active run!';
            }
        });

        console.log('ðŸŽ® Territory Run loaded');
        console.log('Press SPACE to start/stop run, C to center');
    </script>
</body>
</html>
